<mat-horizontal-stepper linear="false">
  @for (hour of tradingHours; track hour) {
    <mat-step [label]="hourLabel(hour)" (opened)="onHourSelected(hour)">
      <div class="timeline-container">
        <!-- LEFT: Tree for this hour -->
        <div class="time-tree">
          <h3 class="section-title">Time Tree</h3>

          <mat-tree
            [dataSource]="timeTreeRoots"
            [childrenAccessor]="childrenAccessor"
            class="mat-elevation-z1"
          >
            <!-- Hour node (has children) -->
            <mat-nested-tree-node
              *matTreeNodeDef="let node; when: hasChild"
              matTreeNodePadding
              [isExpandable]="true"
            >
              <div class="tree-node hour-node">
                <button
                  mat-icon-button
                  matTreeNodeToggle
                  [attr.aria-label]="'Toggle ' + node.label"
                >
                  <mat-icon>expand_more</mat-icon>
                </button>
                <span>{{ node.label }}</span>
              </div>
              <div matTreeNodeOutlet></div>     <!-- âœ… directive, no [] -->
            </mat-nested-tree-node>

            <!-- Minute node (leaf) -->
            <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
              <div
                class="tree-node minute-node"
                [class.selected]="isSelected(node)"
                (click)="onMinuteClick(node)"
              >
                <span>{{ node.label }}</span>
              </div>
            </mat-tree-node>
          </mat-tree>
        </div>

        <!-- RIGHT: Logs + Market/Test filter -->
        <div class="logs-panel">
          <h3 class="section-title">
            Logs
            @if (selectedMinuteNode) {
              <span class="minute-tag">
                {{ selectedMinuteNode.label }}
              </span>
            } @else {
              <span class="minute-tag empty">select a minute</span>
            }
          </h3>

          <div class="source-filter">
            <button
              mat-stroked-button
              [color]="currentSourceFilter === 'ALL' ? 'primary' : undefined"
              (click)="setSourceFilter('ALL')"
            >
              All
            </button>
            <button
              mat-stroked-button
              [color]="currentSourceFilter === 'MARKET' ? 'primary' : undefined"
              (click)="setSourceFilter('MARKET')"
            >
              Market
            </button>
            <button
              mat-stroked-button
              [color]="currentSourceFilter === 'TEST' ? 'primary' : undefined"
              (click)="setSourceFilter('TEST')"
            >
              Test
            </button>
          </div>

          <cdk-virtual-scroll-viewport itemSize="28" class="logs-viewport">
            <table
              mat-table
              [dataSource]="filteredLogs"
              class="mat-elevation-z1 logs-table"
            >
              <ng-container matColumnDef="time">
                <th mat-header-cell *matHeaderCellDef>Time</th>
                <td mat-cell *matCellDef="let log">
                  {{ log.timestamp | date: 'HH:mm:ss' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="symbol">
                <th mat-header-cell *matHeaderCellDef>Symbol</th>
                <td mat-cell *matCellDef="let log">
                  {{ log.symbol }}
                </td>
              </ng-container>

              <ng-container matColumnDef="source">
                <th mat-header-cell *matHeaderCellDef>Source</th>
                <td mat-cell *matCellDef="let log">
                  {{ log.source }}
                </td>
              </ng-container>

              <ng-container matColumnDef="event">
                <th mat-header-cell *matHeaderCellDef>Event</th>
                <td mat-cell *matCellDef="let log">
                  {{ log.event }}
                </td>
              </ng-container>

              <ng-container matColumnDef="details">
                <th mat-header-cell *matHeaderCellDef>Details</th>
                <td mat-cell *matCellDef="let log">
                  {{ log.details }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
          </cdk-virtual-scroll-viewport>
        </div>
      </div>
    </mat-step>
  }
</mat-horizontal-stepper>
